<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç°é‡‘æµæŒ‡æŒ¥èˆ± v5.0</title>
    <meta name="theme-color" content="#0d1117">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi6L+Y5qL+5a2Y5YqpIiwic2hvcnRfbmFtZSI6Iui/mOai/iIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMTIxMjEyIiwidGhlbWVfY29sb3IiOiIjMTIxMjEyIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS8xOTIiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <style>
        :root {
            --bg-color: #0d1117; --card-bg: #161b22; --text-main: #c9d1d9; --text-sub: #8b949e;
            --accent-blue: #58a6ff; --accent-red: #ff7b72; --accent-orange: #d29922;
            --accent-purple: #bc8cff; --accent-green: #3fb950; --border-color: #30363d;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 16px; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        
        /* é¡¶éƒ¨æ“ä½œæ  */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* æ ¸å¿ƒä»ªè¡¨ç›˜å¸ƒå±€ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; position: relative; }
        
        /* ä½™é¢è¾“å…¥å¡ç‰‡ */
        .balance-card { border-color: var(--accent-blue); background: rgba(88, 166, 255, 0.05); }
        .balance-input { background: transparent; border: none; color: #fff; font-size: 24px; font-weight: bold; font-family: 'Monaco', monospace; width: 100%; outline: none; padding: 0; margin-top: 5px; }
        .balance-input::placeholder { color: #444; }

        /* ç¼ºå£å¡ç‰‡ */
        .gap-card { grid-column: 1 / -1; background: #1c2128; border: 2px solid #333; text-align: center; align-items: center; padding: 20px; }
        .gap-value { font-size: 36px; font-weight: 800; font-family: 'Monaco', monospace; margin-top: 5px; transition: color 0.3s; }
        .gap-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }
        
        /* çŠ¶æ€è‰² */
        .status-safe { color: var(--accent-green); border-color: var(--accent-green); }
        .status-danger { color: var(--accent-red); border-color: var(--accent-red); }

        .stat-label { font-size: 11px; color: var(--text-sub); margin-bottom: 6px; letter-spacing: 0.5px; }
        .stat-value { font-size: 20px; font-weight: 700; font-family: 'Monaco', monospace; }
        .currency { font-size: 0.6em; margin-right: 2px; opacity: 0.6; font-weight: normal;}
        
        /* åˆ—è¡¨ä¸æ ·å¼ä¿æŒä¸€è‡´ */
        .section-header { margin: 24px 0 12px 0; padding-left: 10px; border-left: 3px solid var(--accent-blue); font-size: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .debt-list { list-style: none; padding: 0; margin: 0; }
        .debt-item { background: var(--card-bg); margin-bottom: 10px; padding: 12px; border-radius: 8px; display: flex; align-items: center; border: 1px solid var(--border-color); position: relative; overflow: hidden; transition: all 0.2s; }
        .checkbox { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-sub); margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .paid .checkbox { background: var(--accent-green); border-color: var(--accent-green); }
        .checkbox::after { content: 'âœ“'; color: #0d1117; font-size: 14px; font-weight: bold; display: none; }
        .paid .checkbox::after { display: block; }
        .item-content { flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .item-main { flex: 1; }
        .item-top { display: flex; align-items: center; margin-bottom: 4px; }
        .item-name { font-size: 15px; font-weight: 500; margin-right: 8px; }
        .item-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        
        /* æ ‡ç­¾é¢œè‰² */
        .tag-hard { background: rgba(255, 123, 114, 0.15); color: var(--accent-red); }
        .tag-soft { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .tag-expense { background: rgba(210, 153, 34, 0.15); color: var(--accent-orange); }
        .tag-credit { background: rgba(188, 140, 255, 0.15); color: var(--accent-purple); }
        .debt-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .type-hard::before { background: var(--accent-red); }
        .type-soft::before { background: var(--accent-green); }
        .type-expense::before { background: var(--accent-orange); }
        .type-credit::before { background: var(--accent-purple); }

        .item-sub { font-size: 12px; color: var(--text-sub); }
        .days-left { margin-left: 8px; color: var(--text-main); }
        .days-left.warning { color: var(--accent-red); font-weight: bold; }
        .item-amount { font-size: 16px; font-weight: 700; font-family: 'Monaco', monospace; margin-left: 10px;}
        .debt-item.paid { opacity: 0.3; background: #111; border-color: transparent; }
        .debt-item.paid .item-name, .debt-item.paid .item-amount { text-decoration: line-through; }

        /* Chart */
        .chart-container { width: 100%; height: 200px; margin-bottom: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 10px 10px 20px 10px; box-sizing: border-box;}
        svg { width: 100%; height: 100%; overflow: visible; }
        .chart-line { fill: none; stroke-width: 2; stroke-linecap: round; }
        .line-total { stroke: var(--accent-blue); } 
        .line-monthly { stroke: var(--accent-green); }
        .chart-dot { fill: var(--bg-color); stroke-width: 2; }
        .dot-total { stroke: var(--accent-blue); }
        .dot-monthly { stroke: var(--accent-green); }
        .chart-text { fill: var(--text-sub); font-size: 10px; text-anchor: middle; }
        .chart-val { font-size: 9px; text-anchor: middle; font-weight: bold; }
        .val-total { fill: var(--accent-blue); }
        .val-monthly { fill: var(--accent-green); }
        .chart-legend { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; font-size: 11px; }
        .legend-item { display: flex; align-items: center; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }

        /* Calendar */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px; background: var(--card-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .cal-header { font-size: 10px; text-align: center; color: var(--text-sub); margin-bottom: 5px; }
        .cal-day { aspect-ratio: 0.9; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; border-radius: 4px; font-size: 12px; padding-top: 4px; background: #21262d; color: #555; position: relative;}
        .cal-day.active { background: #0d1117; color: var(--text-main); }
        .cal-day.today { border: 1px solid var(--accent-blue); }
        .cal-amt { font-size: 9px; color: var(--text-main); font-weight: bold; margin-top: auto; margin-bottom: 2px; }
        .cal-amt.has-cost { color: var(--accent-red); }
        .cal-dot-container { display: flex; gap: 2px; margin-top: 2px; }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; }
        .dot-hard { background: var(--accent-red); }
        .dot-soft { background: var(--accent-green); }
        .dot-expense { background: var(--accent-orange); }

        /* Modal & Utils */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .modal-content { background: #1c2128; width: 90%; max-height: 85vh; border-radius: 16px; padding: 20px; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .config-item { background: #0d1117; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); }
        .form-input { width: 100%; background: #0d1117; border: 1px solid var(--border-color); padding: 10px; color: white; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px;}
        .btn { padding: 8px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-add { background: var(--accent-blue); color: white; width: 100%; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 15px; z-index: 100; visibility: hidden; opacity: 0; transition: all 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
        details summary { cursor: pointer; color: var(--text-sub); font-size: 14px; padding: 10px 0; outline: none; list-style: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="font-weight:bold; font-size:18px;">ç°é‡‘æµæŒ‡æŒ¥èˆ± v5.0</div>
        <div onclick="openAdmin()" style="cursor:pointer; padding:5px;">âš™ï¸ é…ç½®</div>
    </div>

    <div class="dashboard">
        
        <div class="stat-card balance-card">
            <div class="stat-label">å½“å‰è´¦æˆ·ä½™é¢ (BALANCE)</div>
            <div style="display:flex; align-items:center;">
                <span style="font-size:20px; font-family:'Monaco'; margin-right:2px;">Â¥</span>
                <input type="number" id="currentBalance" class="balance-input" placeholder="0.00" oninput="updateGap()">
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-label">ç¡¬è´Ÿå€ºå‰©ä½™ (TOTAL DEBT)</div>
            <div class="stat-value" id="totalHardDebt">0</div>
        </div>

        <div class="stat-card gap-card" id="gapCard">
            <div class="stat-label">æœ¬æœˆèµ„é‡‘ç¼ºå£ (THE GAP)</div>
            <div class="gap-value" id="gapValue">0</div>
            <div style="font-size:10px; color:#666; margin-top:5px;">ä½™é¢ - æœ¬æœˆå‰©ä½™éœ€è¿˜</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">æœ¬æœˆå‰©ä½™éœ€è¿˜ (REMAINING)</div>
            <div class="stat-value" id="monthCashRemaining" style="color: var(--accent-red)">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">ä¸‹æœˆç°é‡‘é¢„ä¼° (NEXT MONTH)</div>
            <div class="stat-value" id="nextMonthCash">0</div>
        </div>
    </div>

    <div class="section-header"><span>ğŸ“‰ è´Ÿå€ºæ¶ˆé™¤è¶‹åŠ¿ (Next 12 Months)</span></div>
    <div class="chart-container" id="chartContainer"></div>

    <div class="section-header"><span>ğŸ—“ï¸ æœ¬æœˆç°é‡‘æ—¥å† (Cash Calendar)</span></div>
    <div class="calendar" id="calendarGrid"></div>

    <div class="section-header"><span>ğŸ”¥ æœ€è¿‘ 7 å¤© (Urgent)</span></div>
    <ul class="debt-list" id="urgentList"></ul>

    <div class="section-header"><span>ğŸ“š å…¨éƒ¨è´¦å• (All)</span></div>
    <details>
        <summary>ç‚¹å‡»å±•å¼€/æ”¶èµ·å…¨éƒ¨æ˜ç»†</summary>
        <ul class="debt-list" id="allList"></ul>
    </details>

    <div id="toast"><span id="toastMsg">å·²æ ‡è®°å®Œæˆ</span><span style="color:#58a6ff; font-weight:bold; cursor:pointer;" onclick="undo()">æ’¤é”€</span></div>

    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header"><span style="font-weight:bold; font-size:18px;">é…ç½®ç®¡ç†</span><span onclick="closeAdmin()" style="font-size:24px; cursor:pointer;">Ã—</span></div>
            <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px;">
                <div style="margin-bottom:10px; font-weight:bold;">â• æ·»åŠ æ–°é¡¹</div>
                <select id="newType" class="form-input">
                    <option value="hard">ğŸ”´ ç¡¬è´Ÿå€º (è®¡å…¥æ€»å€º/ç°é‡‘)</option>
                    <option value="soft">ğŸŸ¢ è½¯è´Ÿå€º (è®¡å…¥ç°é‡‘)</option>
                    <option value="expense">ğŸŸ  ç°é‡‘æ”¯å‡º (è®¡å…¥ç°é‡‘)</option>
                    <option value="credit">ğŸŸ£ ä¿¡ç”¨å¡ (ä»…çœ‹è´¦å•)</option>
                </select>
                <input type="text" id="newName" class="form-input" placeholder="åç§°">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <input type="number" id="newAmount" class="form-input" placeholder="å‰©ä½™æ€»é¢">
                    <input type="number" id="newPeriods" class="form-input" placeholder="å‰©ä½™æœŸæ•°">
                </div>
                <input type="number" id="newDay" class="form-input" placeholder="æ¯æœˆè¿˜æ¬¾æ—¥(1-31)">
                <button class="btn btn-add" onclick="addNewConfig()">ä¿å­˜</button>
            </div>
            <div id="configList"></div>
            <button class="btn" style="width:100%; margin-top:20px; background:#333; color:#aaa;" onclick="hardReset()">æ¢å¤åˆå§‹æ•°æ®</button>
        </div>
    </div>

<script>
    // é»˜è®¤é…ç½® (ä¿ç•™ä½ çš„æ•°æ®)
    const defaultConfig = [
        ['hard', 'æ´‹é’±ç½8', 2410.89, 1, 4],
        ['hard', 'åˆ†æœŸä¹6', 6931.86, 2, 3],
        ['hard', 'åˆ†æœŸä¹14', 27908.84, 2, 9],
        ['hard', 'äº¬ä¸œ196', 196.26, 2, 1],
        ['hard', 'æ´‹é’±ç½9', 2009.12, 4, 4],
        ['hard', 'å®‰é€¸èŠ±3', 2370.76, 5, 4],
        ['hard', '360-1', 7144.90, 6, 9],
        ['hard', 'æ´‹é’±ç½10', 15691.87, 6, 11],
        ['hard', 'ç¾å›¢15', 15036.00, 12, 9],
        ['hard', '360-2', 2008.65, 17, 2],
        ['hard', 'æ´‹é’±ç½11', 3612.00, 17, 3],
        ['hard', 'ä¸­åŸæ¶ˆè´¹7', 5672.76, 22, 12],
        ['hard', 'æ´‹é’±ç½12', 1970.97, 25, 11],
        ['hard', 'æ´‹é’±ç½13', 331.35, 26, 1],
        ['hard', 'å®‰é€¸èŠ±4', 198.56, 28, 1],
        ['hard', 'å®‰é€¸èŠ±5', 85.11, 28, 3],
        ['soft', 'äº¬ä¸œ800', 800 * 6, 10, 6],
        ['soft', 'èŠ±å‘—500', 500 * 7, 20, 7],
        ['soft', 'ç¾å›¢500', 500 * 10, 22, 10],
        ['expense', 'ç¤¾ä¿ç¼´çº³', 1900 * 12, 10, 12],
        ['credit', 'æ•°ç è®¢é˜…', 715 * 12, 1, 12],
        ['credit', 'å¿ƒç†å’¨è¯¢', 3000 * 12, 1, 12],
        ['credit', 'ä¿¡ç”¨å¡åˆ†æœŸ5', 188.27, 1, 1],
        ['credit', 'ä¿¡ç”¨å¡åˆ†æœŸ3', 8765.12, 6, 16],
        ['credit', 'ä¿¡ç”¨å¡åˆ†æœŸ4', 8982.38, 6, 22],
        ['credit', 'ä¿¡ç”¨å¡åˆ†æœŸ1', 15573.36, 12, 23],
        ['credit', 'ä¿¡ç”¨å¡åˆ†æœŸ2', 5645.43, 13, 21]
    ];

    let currentConfig = [];
    let allDebts = [];
    let lastChangedId = null;
    
    // v5.0 æ–°å¢ï¼šè´¦æˆ·ä½™é¢
    let userBalance = 0;

    function init() {
        // === è‡ªåŠ¨è¿ç§»é€»è¾‘ (v4 -> v5) ===
        // å¦‚æœå‘ç°è€ç‰ˆæœ¬çš„é…ç½®ï¼Œè‡ªåŠ¨æ¬è¿è¿‡æ¥
        if (!localStorage.getItem('debt_config_v5') && localStorage.getItem('debt_config_v4')) {
            localStorage.setItem('debt_config_v5', localStorage.getItem('debt_config_v4'));
            // é‡æ–°ç”Ÿæˆè´¦å•ä»¥é€‚é…æ–°é€»è¾‘
            currentConfig = JSON.parse(localStorage.getItem('debt_config_v5'));
            generateDebts();
        } else {
            // æ­£å¸¸åŠ è½½
            const savedConfig = localStorage.getItem('debt_config_v5');
            currentConfig = savedConfig ? JSON.parse(savedConfig) : JSON.parse(JSON.stringify(defaultConfig));
            
            const savedDebts = localStorage.getItem('debt_items_v5');
            if (savedDebts) { allDebts = JSON.parse(savedDebts); } else { generateDebts(); }
        }

        // åŠ è½½ä½™é¢
        const savedBalance = localStorage.getItem('user_balance_v5');
        if(savedBalance) {
            userBalance = parseFloat(savedBalance);
            document.getElementById('currentBalance').value = userBalance;
        }

        render();
    }

    function generateDebts() {
        allDebts = [];
        let idCounter = 1;
        const startYear = 2025; const startMonth = 12; 

        currentConfig.forEach((loan, index) => {
            let [type, name, totalAmount, day, periods] = loan;
            let amountPerPeriod = totalAmount / periods;
            for (let i = 0; i < periods; i++) {
                let tY = startYear;
                let tM = startMonth + i;
                while (tM > 12) { tM -= 12; tY++; }
                let dateStr = `${tY}-${tM.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                allDebts.push({
                    id: idCounter++, configIndex: index, name: name, type: type, amount: amountPerPeriod,
                    dueDate: dateStr, paid: false, periodInfo: `${i+1}/${periods}`
                });
            }
        });
        saveDebts();
    }

    // === æ ¸å¿ƒï¼šæ›´æ–° GAP é€»è¾‘ ===
    function updateGap() {
        const val = document.getElementById('currentBalance').value;
        userBalance = val ? parseFloat(val) : 0;
        localStorage.setItem('user_balance_v5', userBalance);
        render(); // é‡æ–°è®¡ç®—å¹¶æ¸²æŸ“GAP
    }

    function render() {
        const today = new Date();
        today.setHours(0,0,0,0);
        
        let totalHard = 0;
        let monthCashRemaining = 0; // æœ¬æœˆå‰©ä½™éœ€è¿˜ (ä¸å«å·²è¿˜)
        let nextMonthCash = 0;

        // è¿™é‡Œçš„é€»è¾‘æ”¹ä¸ºï¼šä¸¥æ ¼æ˜¾ç¤ºâ€œæœ¬æœˆâ€ï¼Œå“ªæ€•æ˜¯æœˆåº•
        let currentMonthStr = today.toISOString().slice(0, 7);
        
        let nextM = today.getMonth() + 2; let nextY = today.getFullYear();
        if (nextM > 12) { nextM = 1; nextY++; }
        let nextMonthStr = `${nextY}-${nextM.toString().padStart(2, '0')}`;

        allDebts.forEach(item => {
            if (!item.paid) {
                if (item.type === 'hard') totalHard += item.amount;
                
                // æœ¬æœˆå‰©ä½™ (Hard + Soft + Expense)
                if (item.dueDate.startsWith(currentMonthStr)) {
                    if (['hard', 'soft', 'expense'].includes(item.type)) {
                        monthCashRemaining += item.amount;
                    }
                }
                
                // ä¸‹æœˆé¢„æµ‹
                if (item.dueDate.startsWith(nextMonthStr)) {
                    if (['hard', 'soft', 'expense'].includes(item.type)) {
                        nextMonthCash += item.amount;
                    }
                }
            }
        });

        // 1. æ›´æ–° Gap
        const gap = userBalance - monthCashRemaining;
        const gapEl = document.getElementById('gapValue');
        const gapCard = document.getElementById('gapCard');
        
        // æ ¼å¼åŒ– GAP æ˜¾ç¤º
        if (gap >= 0) {
            gapEl.innerHTML = `+${formatMoney(gap)}`;
            gapEl.style.color = '#3fb950'; // Green
            gapCard.style.borderColor = '#3fb950';
        } else {
            gapEl.innerHTML = `-${formatMoney(Math.abs(gap))}`;
            gapEl.style.color = '#ff7b72'; // Red
            gapCard.style.borderColor = '#ff7b72';
        }

        // 2. æ›´æ–°å…¶ä»–æ•°å­—
        document.getElementById('totalHardDebt').innerHTML = `<span class="currency">Â¥</span>${formatMoney(totalHard)}`;
        document.getElementById('monthCashRemaining').innerHTML = `<span class="currency">Â¥</span>${formatMoney(monthCashRemaining)}`;
        document.getElementById('nextMonthCash').innerHTML = `<span class="currency">Â¥</span>${formatMoney(nextMonthCash)}`;

        renderLists(today);
        renderChart(today, totalHard);
        renderCalendar(today);
    }

    function renderLists(today) {
        allDebts.sort((a, b) => {
            if (a.paid !== b.paid) return a.paid ? 1 : -1;
            return new Date(a.dueDate) - new Date(b.dueDate);
        });
        const urgentList = document.getElementById('urgentList');
        const allList = document.getElementById('allList');
        urgentList.innerHTML = ''; allList.innerHTML = '';

        let urgentCount = 0;
        allDebts.forEach(item => {
            const dDate = new Date(item.dueDate); dDate.setHours(0,0,0,0);
            const diffDays = Math.ceil((dDate - today) / (1000 * 60 * 60 * 24));
            const isUrgent = !item.paid && diffDays <= 7 && diffDays >= -30 && item.type !== 'credit';
            const html = createCard(item, diffDays);
            if (isUrgent) { urgentList.innerHTML += html; urgentCount++; }
            if (allList.children.length < 100) allList.innerHTML += html;
        });
        if (urgentCount === 0) urgentList.innerHTML = '<div style="text-align:center; padding:15px; color:#666; font-size:13px;">æ— ç´§æ€¥å¾…è¿˜</div>';
    }

    function createCard(item, diffDays) {
        let tagNames = { 'hard': 'ç¡¬å€º', 'soft': 'åˆ†æœŸ', 'expense': 'æ”¯å‡º', 'credit': 'ä¿¡ç”¨' };
        let urgentClass = (!item.paid && diffDays <= 3) ? 'warning' : '';
        let dayText = item.paid ? 'å·²å®Œæˆ' : (diffDays === 0 ? 'ä»Šå¤©!' : (diffDays < 0 ? `é€¾æœŸ${Math.abs(diffDays)}å¤©` : `${diffDays}å¤©å`));
        return `
        <li class="debt-item type-${item.type} ${item.paid ? 'paid' : ''}" onclick="toggle(${item.id})">
            <div class="checkbox"></div>
            <div class="item-content">
                <div class="item-main">
                    <div class="item-top">
                        <span class="item-tag tag-${item.type}">${tagNames[item.type]}</span>
                        <span class="item-name">${item.name}</span>
                        <span style="font-size:10px; color:#666;">${item.periodInfo}</span>
                    </div>
                    <div class="item-sub"><span>${item.dueDate}</span><span class="days-left ${urgentClass}">${dayText}</span></div>
                </div>
                <div class="item-amount">Â¥${Math.round(item.amount)}</div>
            </div>
        </li>`;
    }

    function renderChart(today, currentTotalHard) {
        const points = [];
        let tempTotal = currentTotalHard;
        const futureHardDebts = allDebts.filter(d => d.type === 'hard' && !d.paid).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
        const futureMonthlyDebts = allDebts.filter(d => (d.type === 'hard' || d.type === 'soft') && !d.paid);

        let cM = today.getMonth(); let cY = today.getFullYear();
        points.push({ label: 'Now', val: tempTotal });

        for(let i=1; i<=12; i++) {
            let m = cM + i; let y = cY;
            if(m > 11) { m -= 12; y++; }
            let prefix = `${y}-${(m+1).toString().padStart(2,'0')}`;
            let payHard = futureHardDebts.filter(d => d.dueDate.startsWith(prefix)).reduce((s, d) => s + d.amount, 0);
            tempTotal -= payHard; if(tempTotal < 0) tempTotal = 0;
            let payMonthly = futureMonthlyDebts.filter(d => d.dueDate.startsWith(prefix)).reduce((s, d) => s + d.amount, 0);
            points.push({ label: `${m+1}æœˆ`, total: tempTotal, monthly: payMonthly });
        }

        const container = document.getElementById('chartContainer');
        container.innerHTML = `<div class="chart-legend"><div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div><span>ç¡¬è´Ÿå€ºå‰©ä½™</span></div><div class="legend-item"><div class="legend-dot" style="background:#3fb950"></div><span>æ¯æœˆåº”è¿˜(å€º)</span></div></div>`;
        const svgW = container.clientWidth; const svgH = 160; const pad = 20; const chartH = svgH - pad*2;
        const maxVal = currentTotalHard || 10000;
        let pathTotal = ''; let pathMonthly = ''; let elements = '';

        points.forEach((pt, i) => {
            let x = pad + (i / (points.length - 1)) * (svgW - 2 * pad);
            let yTotal = svgH - pad - (pt.total / maxVal) * chartH;
            if (i===0) pathTotal = `M ${x} ${yTotal}`; else pathTotal += ` L ${x} ${yTotal}`;
            
            // ç»¿çº¿ç”¨ç‹¬ç«‹æ¯”ä¾‹å°ºä¼šæ›´å¥½çœ‹ï¼Œè¿™é‡Œç®€å•å¤„ç†ç”¨ç»Ÿä¸€æ¯”ä¾‹
            let yMonthly = svgH - pad - (pt.monthly / maxVal) * chartH; 
            if (i===0) pathMonthly = `M ${x} ${yMonthly}`; else pathMonthly += ` L ${x} ${yMonthly}`;

            if (i % 2 === 0 || i === points.length - 1) {
                elements += `<circle cx="${x}" cy="${yTotal}" r="3" class="chart-dot dot-total" /><text x="${x}" y="${yTotal - 8}" class="chart-val val-total">${(pt.total/1000).toFixed(0)}k</text><circle cx="${x}" cy="${yMonthly}" r="3" class="chart-dot dot-monthly" /><text x="${x}" y="${yMonthly - 8}" class="chart-val val-monthly">${(pt.monthly/1000).toFixed(1)}k</text><text x="${x}" y="${svgH - 5}" class="chart-text">${pt.label}</text>`;
            }
        });
        container.innerHTML += `<svg viewBox="0 0 ${svgW} ${svgH}"><path d="${pathTotal}" class="chart-line line-total" /><path d="${pathMonthly}" class="chart-line line-monthly" />${elements}</svg>`;
    }

    function renderCalendar(today) {
        const y = today.getFullYear(); const m = today.getMonth();
        const daysInM = new Date(y, m + 1, 0).getDate();
        const firstDay = new Date(y, m, 1).getDay();
        const prefix = `${y}-${(m+1).toString().padStart(2, '0')}`;
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '<div class="cal-header">æ—¥</div><div class="cal-header">ä¸€</div><div class="cal-header">äºŒ</div><div class="cal-header">ä¸‰</div><div class="cal-header">å››</div><div class="cal-header">äº”</div><div class="cal-header">å…­</div>';
        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div class="cal-day"></div>';
        for(let d=1; d<=daysInM; d++) {
            const dateStr = `${prefix}-${d.toString().padStart(2,'0')}`;
            const items = allDebts.filter(i => i.dueDate === dateStr && !i.paid && ['hard','soft','expense'].includes(i.type));
            let totalAmt = items.reduce((s, i) => s + i.amount, 0);
            let amtHtml = totalAmt > 0 ? `<div class="cal-amt has-cost">${(totalAmt/1000).toFixed(1)}k</div>` : '';
            let dots = ''; items.forEach(i => dots += `<div class="cal-dot dot-${i.type}"></div>`);
            let cls = d === today.getDate() ? 'cal-day today active' : 'cal-day active';
            grid.innerHTML += `<div class="${cls}"><span>${d}</span><div class="cal-dot-container">${dots}</div>${amtHtml}</div>`;
        }
    }

    function toggle(id) {
        const idx = allDebts.findIndex(d => d.id === id);
        if (idx > -1) {
            allDebts[idx].paid = !allDebts[idx].paid;
            lastChangedId = id;
            saveDebts(); render();
            if (allDebts[idx].paid) showToast();
        }
    }

    // Admin & Utils
    function openAdmin() { document.getElementById('adminModal').className = 'modal open'; renderConfigList(); }
    function closeAdmin() { document.getElementById('adminModal').className = 'modal'; generateDebts(); render(); }
    function renderConfigList() {
        const list = document.getElementById('configList'); list.innerHTML = '';
        currentConfig.forEach((cfg, i) => {
            let [t, n, a, d, p] = cfg;
            let div = document.createElement('div'); div.className = 'config-item';
            div.innerHTML = `<div style="font-size:12px;"><span style="color:#fff;font-weight:bold;">${n}</span> <span style="color:#666;">${t.toUpperCase()} | ${a}å…ƒ | ${d}æ—¥ | ${p}æœŸ</span></div><button class="btn" style="background:rgba(255,82,82,0.2); color:#ff7b72;" onclick="delCfg(${i})">åˆ </button>`;
            list.appendChild(div);
        });
    }
    function addNewConfig() {
        const t = document.getElementById('newType').value; const n = document.getElementById('newName').value;
        const a = parseFloat(document.getElementById('newAmount').value); const p = parseInt(document.getElementById('newPeriods').value);
        const d = parseInt(document.getElementById('newDay').value);
        if(!n||!a||!p||!d) return;
        currentConfig.push([t, n, a, d, p]); saveConfig();
        document.getElementById('newName').value=''; document.getElementById('newAmount').value=''; document.getElementById('newPeriods').value='';
        renderConfigList();
    }
    function delCfg(i) { if(confirm('åˆ ?')) { currentConfig.splice(i, 1); saveConfig(); renderConfigList(); } }
    
    function undo() { if (lastChangedId) { toggle(lastChangedId); document.getElementById('toast').className = ''; } }
    function showToast() { const t = document.getElementById('toast'); t.className = 'show'; setTimeout(() => t.className = '', 2000); }
    function hardReset() { if(confirm('Reset?')) { localStorage.removeItem('debt_config_v5'); localStorage.removeItem('debt_items_v5'); localStorage.removeItem('user_balance_v5'); location.reload(); } }
    function saveDebts() { localStorage.setItem('debt_items_v5', JSON.stringify(allDebts)); }
    function saveConfig() { localStorage.setItem('debt_config_v5', JSON.stringify(currentConfig)); }
    function formatMoney(n) { return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }

    init();
</script>
</body>
</html>
